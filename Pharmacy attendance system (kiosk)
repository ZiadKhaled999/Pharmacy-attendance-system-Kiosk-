<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Attendance Kiosk</title>
    <!-- Chart.js for offline charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg-main: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundShift 20s ease infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(99, 102, 241, 0.1) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem 2.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .header-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .header-title h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--text-primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .status-badge {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }

        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .current-time {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 2rem;
        }

        /* Card Base */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px var(--shadow);
            transition: all 0.3s;
            position: relative;
        }

        .card:hover {
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Date Display */
        .date-display {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .date-display p {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Buttons */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-large {
            width: 100%;
            padding: 1.5rem;
            font-size: 1.125rem;
            font-weight: 700;
            border-radius: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(99, 102, 241, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(239, 68, 68, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: var(--bg-card-hover);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Active Employees */
        .active-section {
            margin-top: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            border: 2px solid var(--primary);
            border-radius: 16px;
            animation: borderGlow 3s ease infinite;
        }

        @keyframes borderGlow {
            0%, 100% { border-color: var(--primary); box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
            50% { border-color: var(--secondary); box-shadow: 0 0 30px rgba(139, 92, 246, 0.4); }
        }

        .active-section-title {
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--primary-light);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .active-section-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: pulse 2s ease infinite;
        }

        .active-list {
            max-height: 280px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .active-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.3s;
        }

        .active-item:hover {
            background: var(--bg-card-hover);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .active-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .active-item-name {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .active-item-timer {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-variant-numeric: tabular-nums;
        }

        .active-item-info {
            font-size: 0.875rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px var(--shadow);
        }

        .stat-card.blue::before { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .stat-card.teal::before { background: linear-gradient(90deg, #14b8a6, #0d9488); }
        .stat-card.purple::before { background: linear-gradient(90deg, #a855f7, #9333ea); }

        .stat-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        /* View Switcher */
        .view-switcher {
            display: flex;
            gap: 1rem;
            background: var(--bg-card);
            padding: 0.75rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .view-btn {
            flex: 1;
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            border-radius: 12px;
            color: var(--text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .view-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .view-btn:not(.active):hover {
            background: var(--bg-card-hover);
            color: var(--text-secondary);
        }

        /* Content Area */
        .content-area {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2.5rem;
            min-height: 600px;
        }

        .content-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .content-title::before {
            content: '';
            width: 4px;
            height: 32px;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            color: var(--text-primary);
            padding: 1.25rem 1.5rem;
            text-align: left;
            font-weight: 700;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 1.25rem 1.5rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            font-size: 0.9375rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .status-badge-table {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.8125rem;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-completed {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
            border: 1px solid var(--info);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 560px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }

        .modal-header h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 2rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* Input */
        input[type="text"],
        textarea {
            width: 100%;
            padding: 1rem 1.25rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
            font-family: inherit;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .input-label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }

        /* Profile List */
        .profile-list {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .profile-item {
            width: 100%;
            padding: 1.25rem 1.5rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }

        .profile-item:hover {
            background: var(--bg-card-hover);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .profile-item.active-profile {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }

        .profile-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.0625rem;
        }

        .profile-badge-small {
            padding: 0.375rem 0.875rem;
            border-radius: 50px;
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .profile-badge-small.available {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .profile-badge-small.active {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .empty-state small {
            font-size: 0.9375rem;
            color: var(--text-muted);
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .summary-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
        }

        .summary-card h4 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
        }

        .summary-card .value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-main);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .hidden {
            display: none !important;
        }

        /* Calendar Styles */
        .calendar-container {
            margin-top: 2rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .calendar-nav button {
            padding: 0.5rem 1rem;
            background: var(--bg-card-hover);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-nav button:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .calendar-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day-header {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
        }

        .calendar-day {
            aspect-ratio: 1;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-card-hover);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .calendar-day.has-data {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .calendar-day.today {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day-number {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .calendar-day-sessions {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .chart-canvas {
            width: 100%;
            height: 400px;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9375rem;
        }

        .filter-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
        }

        /* Compare Grid */
        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .compare-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s;
        }

        .compare-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
        }

        .compare-card.winner {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .compare-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .compare-card-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .compare-badge {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .compare-stats {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .compare-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .compare-stat-label {
            color: var(--text-muted);
            font-size: 0.9375rem;
        }

        .compare-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <div class="header-icon">üè•</div>
                <h1>Pharmacy Attendance System</h1>
            </div>
            <div class="header-info">
                <div class="status-badge" id="status-badge">System Online</div>
                <div class="current-time" id="current-time">00:00:00</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Left Sidebar -->
            <div>
                <!-- Control Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">‚è∞</div>
                        <h2>Time Clock</h2>
                    </div>

                    <div class="date-display">
                        <p id="current-date">Loading...</p>
                    </div>

                    <button class="btn btn-primary btn-large" id="checkin-btn">
                        <span>‚úì</span>
                        <span>Check In</span>
                    </button>

                    <button class="btn btn-danger btn-large" id="checkout-btn" style="margin-top: 1rem;">
                        <span>‚óº</span>
                        <span>Check Out</span>
                    </button>

                    <div class="active-section hidden" id="active-section">
                        <div class="active-section-title">Active Employees</div>
                        <div class="active-list" id="active-list"></div>
                    </div>
                </div>

                <!-- Stats -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; width: 100%; margin-top: 2rem;">
                    <div class="stat-card blue">
                        <div class="stat-header">Today's Hours</div>
                        <div class="stat-value" id="total-hours">00:00</div>
                    </div>
                    <div class="stat-card teal">
                        <div class="stat-header">Active Now</div>
                        <div class="stat-value" id="active-count">0</div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-header">Sessions</div>
                        <div class="stat-value" id="session-count">0</div>
                    </div>
                </div>

                <!-- Exit Button -->
                <button class="btn btn-danger btn-large" id="exit-btn" style="margin-top: 2rem;">
                    <span>üö™</span>
                    <span>Close Pharmacy & Backup</span>
                </button>
            </div>

            <!-- Right Content -->
            <div>
                <!-- View Switcher -->
                <div class="view-switcher">
                    <button class="view-btn active" id="daily-btn">
                        <span>üìä</span>
                        <span>Daily Log</span>
                    </button>
                    <button class="view-btn" id="monthly-btn">
                        <span>üìà</span>
                        <span>Monthly Report</span>
                    </button>
                    <button class="view-btn" id="history-btn">
                        <span>üìÖ</span>
                        <span>History</span>
                    </button>
                    <button class="view-btn" id="analytics-btn">
                        <span>üìâ</span>
                        <span>Analytics</span>
                    </button>
                    <button class="view-btn" id="compare-btn">
                        <span>‚öñÔ∏è</span>
                        <span>Compare</span>
                    </button>
                    <button class="view-btn" id="manage-btn">
                        <span>‚öôÔ∏è</span>
                        <span>Manage</span>
                    </button>
                </div>

                <!-- Content Area -->
                <div class="content-area" id="content-area"></div>
            </div>
        </div>
    </div>

    <!-- Check-In Modal -->
    <div class="modal" id="checkin-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üë§</div>
                <h3>Check In</h3>
            </div>
            <div class="modal-body">
                <input type="text" id="profile-search" placeholder="Search or enter employee name..." style="margin-bottom: 1.5rem;">
                <div class="profile-list" id="profile-list"></div>
                <button class="btn btn-success btn-large hidden" id="create-profile-btn">
                    <span>+</span>
                    <span>Add New Employee</span>
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-checkin-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Check-Out Selection Modal -->
    <div class="modal" id="checkout-selection-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üë•</div>
                <h3>Select Employee</h3>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Choose who is checking out:</p>
                <div class="profile-list" id="checkout-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-checkout-selection-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Check-Out Confirmation Modal -->
    <div class="modal" id="checkout-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üìù</div>
                <h3>Confirm Check-Out</h3>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    Checking out <strong style="color: var(--text-primary);" id="checkout-name"></strong>
                </p>
                <label class="input-label">Reason (Optional)</label>
                <textarea id="checkout-reason" placeholder="Enter reason for break or end of shift..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-checkout-confirm-btn">Cancel</button>
                <button class="btn btn-danger" id="confirm-checkout-btn">
                    <span>‚úì</span>
                    <span>Confirm Check-Out</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="modal" id="day-detail-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-icon">üìÖ</div>
                <h3 id="day-detail-title">Day Details</h3>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label class="input-label">Filter by Employee (Optional)</label>
                    <select id="day-detail-employee" style="width: 100%; padding: 0.75rem 1rem; background: var(--bg-main); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: 1rem;">
                        <option value="">All Employees</option>
                    </select>
                </div>
                <div id="day-detail-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-day-detail-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Month Detail Modal -->
    <div class="modal" id="month-detail-modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-icon">üìä</div>
                <h3 id="month-detail-title">Month Details</h3>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <label class="input-label">Filter by Employee (Optional)</label>
                    <select id="month-detail-employee" style="width: 100%; padding: 0.75rem 1rem; background: var(--bg-main); border: 1px solid var(--border); border-radius: 12px; color: var(--text-primary); font-size: 1rem;">
                        <option value="">All Employees</option>
                    </select>
                </div>
                <div id="month-detail-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-month-detail-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div class="modal" id="pin-modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <div class="modal-icon">üîê</div>
                <h3 id="pin-modal-title">Enter PIN</h3>
            </div>
            <div class="modal-body">
                <p id="pin-modal-message" style="color: var(--text-secondary); margin-bottom: 1.5rem; text-align: center;">
                    Enter your 6-digit PIN to unlock your data
                </p>
                <div style="display: flex; gap: 0.75rem; justify-content: center; margin-bottom: 1.5rem;">
                    <input type="password" maxlength="1" class="pin-input" id="pin-1" style="width: 50px; height: 60px; text-align: center; font-size: 2rem; padding: 0; background: var(--bg-main); border: 2px solid var(--border); border-radius: 12px; color: var(--text-primary); font-weight: 700;">
                    <input type="password" maxlength="1" class="pin-input" id="pin-2" style="width: 50px; height: 60px; text-align: center; font-size: 2rem; padding: 0; background: var(--bg-main); border: 2px solid var(--border); border-radius: 12px; color: var(--text-primary); font-weight: 700;">
                    <input type="password" maxlength="1" class="pin-input" id="pin-3" style="width: 50px; height: 60px; text-align: center; font-size: 2rem; padding: 0; background: var(--bg-main); border: 2px solid var(--border); border-radius: 12px; color: var(--text-primary); font-weight: 700;">
                    <input type="password" maxlength="1" class="pin-input" id="pin-4" style="width: 50px; height: 60px; text-align: center; font-size: 2rem; padding: 0; background: var(--bg-main); border: 2px solid var(--border); border-radius: 12px; color: var(--text-primary); font-weight: 700;">
                    <input type="password" maxlength="1" class="pin-input" id="pin-5" style="width: 50px; height: 60px; text-align: center; font-size: 2rem; padding: 0; background: var(--bg-main); border: 2px solid var(--border); border-radius: 12px; color: var(--text-primary); font-weight: 700;">
                    <input type="password" maxlength="1" class="pin-input" id="pin-6" style="width: 50px; height: 60px; text-align: center; font-size: 2rem; padding: 0; background: var(--bg-main); border: 2px solid var(--border); border-radius: 12px; color: var(--text-primary); font-weight: 700;">
                </div>
                <div id="pin-error" style="color: var(--danger); text-align: center; margin-bottom: 1rem; display: none; font-weight: 600;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-pin-btn">Cancel</button>
                <button class="btn btn-primary" id="confirm-pin-btn">
                    <span>‚úì</span>
                    <span id="pin-btn-text">Unlock</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Suppress console in production
        if (window.location.protocol === 'file:') {
            console.log = console.warn = console.error = function() {};
        }

        const STORAGE_KEY = 'PHARMACY_ATTENDANCE_DATA_V2';
        const PIN_STORAGE_KEY = 'PHARMACY_EMPLOYEE_PINS';
        let appData = { profiles: [], sessions: [] };
        let employeePins = {}; // { employeeName: { pin: "123456", unlocked: false } }
        let currentView = 'daily';
        let updateInterval = null;
        let selectedCheckoutEmployee = null;
        let currentCalendarDate = new Date();
        let selectedDayData = null;
        let currentUnlockingEmployee = null;
        let calendarViewType = 'days'; // 'days' or 'months'
        let currentChartInstance = null;

        // ===== INITIALIZATION =====
        function init() {
            try {
                loadData();
                setupEventListeners();
                updateDateTime();
                updateUI();
                startTimers();
            } catch (error) {
                showStatus('Initialization error', 'error');
            }
        }

        function loadData() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    appData = JSON.parse(stored);
                    if (!appData.profiles) appData.profiles = [];
                    if (!appData.sessions) appData.sessions = [];
                }
                
                // Load PINs
                const pinsStored = localStorage.getItem(PIN_STORAGE_KEY);
                if (pinsStored) {
                    employeePins = JSON.parse(pinsStored);
                } else {
                    employeePins = {};
                }
                
                // Initialize PINs for existing profiles
                appData.profiles.forEach(profile => {
                    if (!employeePins[profile.name]) {
                        employeePins[profile.name] = { pin: null, unlocked: false };
                    }
                });
                savePins();
            } catch (error) {
                appData = { profiles: [], sessions: [] };
                employeePins = {};
            }
        }

        function savePins() {
            try {
                localStorage.setItem(PIN_STORAGE_KEY, JSON.stringify(employeePins));
                return true;
            } catch (error) {
                return false;
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                return true;
            } catch (error) {
                showStatus('Failed to save data', 'error');
                return false;
            }
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            document.getElementById('checkin-btn').addEventListener('click', showCheckinModal);
            document.getElementById('checkout-btn').addEventListener('click', showCheckoutSelectionModal);
            document.getElementById('exit-btn').addEventListener('click', showExitModal);
            document.getElementById('daily-btn').addEventListener('click', () => switchView('daily'));
            document.getElementById('monthly-btn').addEventListener('click', () => switchView('monthly'));
            document.getElementById('history-btn').addEventListener('click', () => switchView('history'));
            document.getElementById('analytics-btn').addEventListener('click', () => switchView('analytics'));
            document.getElementById('compare-btn').addEventListener('click', () => switchView('compare'));
            document.getElementById('manage-btn').addEventListener('click', () => switchView('manage'));
            document.getElementById('profile-search').addEventListener('input', filterProfiles);
            document.getElementById('create-profile-btn').addEventListener('click', createProfile);
            document.getElementById('cancel-checkin-btn').addEventListener('click', () => hideModal('checkin-modal'));
            document.getElementById('cancel-checkout-selection-btn').addEventListener('click', () => hideModal('checkout-selection-modal'));
            document.getElementById('cancel-checkout-confirm-btn').addEventListener('click', () => hideModal('checkout-confirm-modal'));
            document.getElementById('confirm-checkout-btn').addEventListener('click', confirmCheckout);
            document.getElementById('cancel-exit-btn').addEventListener('click', () => hideModal('exit-modal'));
            document.getElementById('confirm-exit-btn').addEventListener('click', confirmExit);
            document.getElementById('close-day-detail-btn').addEventListener('click', () => hideModal('day-detail-modal'));
            document.getElementById('day-detail-employee').addEventListener('change', updateDayDetail);
            document.getElementById('close-month-detail-btn').addEventListener('click', () => hideModal('month-detail-modal'));
            document.getElementById('month-detail-employee').addEventListener('change', updateMonthDetail);
            document.getElementById('cancel-pin-btn').addEventListener('click', () => hideModal('pin-modal'));
            document.getElementById('confirm-pin-btn').addEventListener('click', handlePinSubmit);
            
            // Setup PIN input handlers
            setupPinInputs();
        }

        function setupPinInputs() {
            const inputs = document.querySelectorAll('.pin-input');
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1 && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
            });
        }

        // ===== DATE & TIME =====
        function updateDateTime() {
            try {
                const now = new Date();
                
                // Update current time in 12-hour format
                const timeStr = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
                document.getElementById('current-time').textContent = timeStr;
                
                // Update date
                const dateStr = now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                document.getElementById('current-date').textContent = dateStr;
            } catch (error) {
                // Silent fail
            }
        }

        function formatTime(seconds) {
            if (!seconds || seconds < 0) return '00:00:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${pad(h)}:${pad(m)}:${pad(s)}`;
        }

        function formatHoursMinutes(seconds) {
            if (!seconds || seconds < 0) return '00:00';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${pad(h)}:${pad(m)}`;
        }

        function pad(num) {
            return String(num).padStart(2, '0');
        }

        function getTodayString() {
            const d = new Date();
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        }

        function getDateString(timestamp) {
            const d = new Date(timestamp);
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        // ===== STATUS =====
        function showStatus(message, type = 'success') {
            try {
                const badge = document.getElementById('status-badge');
                const colors = {
                    success: 'linear-gradient(135deg, var(--success), #059669)',
                    error: 'linear-gradient(135deg, var(--danger), #dc2626)',
                    warning: 'linear-gradient(135deg, var(--warning), #d97706)'
                };
                
                badge.textContent = message;
                badge.style.background = colors[type] || colors.success;
                
                setTimeout(() => {
                    badge.textContent = 'System Online';
                    badge.style.background = colors.success;
                }, 3000);
            } catch (error) {
                // Silent fail
            }
        }

        // ===== TIMERS =====
        function startTimers() {
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(() => {
                updateDateTime();
                updateActiveList();
                updateStats();
            }, 1000);
        }

        // ===== UI UPDATES =====
        function updateUI() {
            try {
                updateStats();
                updateActiveList();
                updateContent();
            } catch (error) {
                // Silent fail
            }
        }

        function updateStats() {
            try {
                const today = getTodayString();
                const todaySessions = appData.sessions.filter(s => getDateString(s.checkInTime) === today);

                let totalSeconds = 0;
                todaySessions.forEach(s => {
                    const end = s.checkOutTime || Date.now();
                    totalSeconds += Math.floor((end - s.checkInTime) / 1000);
                });

                document.getElementById('total-hours').textContent = formatHoursMinutes(totalSeconds);
                document.getElementById('active-count').textContent = appData.profiles.filter(p => p.activeSessionId).length;
                document.getElementById('session-count').textContent = todaySessions.length;
            } catch (error) {
                // Silent fail
            }
        }

        function updateActiveList() {
            try {
                const activeProfiles = appData.profiles.filter(p => p.activeSessionId);
                const section = document.getElementById('active-section');
                const list = document.getElementById('active-list');
                
                if (activeProfiles.length === 0) {
                    section.classList.add('hidden');
                    return;
                }
                
                section.classList.remove('hidden');
                list.innerHTML = '';
                
                activeProfiles.forEach(profile => {
                    const session = appData.sessions.find(s => s.sessionId === profile.activeSessionId);
                    if (session) {
                        const elapsed = Math.floor((Date.now() - session.checkInTime) / 1000);
                        const checkinTime = new Date(session.checkInTime).toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        
                        const item = document.createElement('div');
                        item.className = 'active-item';
                        item.innerHTML = `
                            <div class="active-item-header">
                                <div class="active-item-name">${profile.name}</div>
                                <div class="active-item-timer">${formatTime(elapsed)}</div>
                            </div>
                            <div class="active-item-info">
                                <span>‚è∞</span>
                                <span>Started at ${checkinTime}</span>
                            </div>
                        `;
                        list.appendChild(item);
                    }
                });
            } catch (error) {
                // Silent fail
            }
        }

        // ===== MODALS =====
        function showModal(id) {
            document.getElementById(id).classList.add('show');
        }

        function hideModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // ===== CHECK-IN =====
        function showCheckinModal() {
            try {
                document.getElementById('profile-search').value = '';
                renderProfileList();
                showModal('checkin-modal');
            } catch (error) {
                showStatus('Error opening check-in', 'error');
            }
        }

        function filterProfiles() {
            renderProfileList();
        }

        function renderProfileList() {
            try {
                const search = document.getElementById('profile-search').value.trim().toLowerCase();
                const list = document.getElementById('profile-list');
                const createBtn = document.getElementById('create-profile-btn');
                
                list.innerHTML = '';
                
                const filtered = appData.profiles.filter(p => p.name.toLowerCase().includes(search));
                const exactMatch = appData.profiles.some(p => p.name.toLowerCase() === search);
                
                if (filtered.length > 0) {
                    filtered.forEach(profile => {
                        const item = document.createElement('button');
                        item.className = 'profile-item' + (profile.activeSessionId ? ' active-profile' : '');
                        item.innerHTML = `
                            <div class="profile-name">${profile.name}</div>
                            <div class="profile-badge-small ${profile.activeSessionId ? 'active' : 'available'}">
                                ${profile.activeSessionId ? 'Active' : 'Available'}
                            </div>
                        `;
                        item.onclick = () => selectProfile(profile.name);
                        list.appendChild(item);
                    });
                } else if (search) {
                    list.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:2rem;">No employees found</p>';
                }
                
                if (search && !exactMatch) {
                    createBtn.classList.remove('hidden');
                } else {
                    createBtn.classList.add('hidden');
                }
            } catch (error) {
                showStatus('Error rendering profiles', 'error');
            }
        }

        function createProfile() {
            try {
                const name = document.getElementById('profile-search').value.trim();
                if (!name) return;
                
                if (appData.profiles.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    showStatus('Employee already exists', 'error');
                    return;
                }
                
                appData.profiles.push({ name, activeSessionId: null });
                saveData();
                selectProfile(name);
                
                // Initialize PIN for new employee
                if (!employeePins[name]) {
                    employeePins[name] = { pin: null, unlocked: false };
                    savePins();
                }
            } catch (error) {
                showStatus('Error creating profile', 'error');
            }
        }

        function selectProfile(name) {
            try {
                hideModal('checkin-modal');
                const profile = appData.profiles.find(p => p.name === name);
                if (!profile) return;
                
                if (profile.activeSessionId) {
                    showStatus(`${name} is already checked in`, 'warning');
                } else {
                    checkIn(name);
                }
            } catch (error) {
                showStatus('Error selecting profile', 'error');
            }
        }

        function checkIn(name) {
            try {
                const profile = appData.profiles.find(p => p.name === name);
                if (!profile) return;
                
                const sessionId = generateId();
                const session = {
                    sessionId,
                    name,
                    checkInTime: Date.now(),
                    checkOutTime: null,
                    reason: null
                };
                
                profile.activeSessionId = sessionId;
                appData.sessions.push(session);
                
                if (saveData()) {
                    showStatus(`${name} checked in successfully`);
                    updateUI();
                }
            } catch (error) {
                showStatus('Check-in failed', 'error');
            }
        }

        // ===== CHECK-OUT =====
        function showCheckoutSelectionModal() {
            try {
                const activeProfiles = appData.profiles.filter(p => p.activeSessionId);
                
                if (activeProfiles.length === 0) {
                    showStatus('No active employees', 'warning');
                    return;
                }
                
                const list = document.getElementById('checkout-list');
                list.innerHTML = '';
                
                activeProfiles.forEach(profile => {
                    const session = appData.sessions.find(s => s.sessionId === profile.activeSessionId);
                    if (session) {
                        const elapsed = Math.floor((Date.now() - session.checkInTime) / 1000);
                        const checkinTime = new Date(session.checkInTime).toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        
                        const item = document.createElement('button');
                        item.className = 'profile-item active-profile';
                        item.innerHTML = `
                            <div>
                                <div class="profile-name">${profile.name}</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    Active for ${formatTime(elapsed)} ‚Ä¢ Since ${checkinTime}
                                </div>
                            </div>
                            <div class="active-item-timer">${formatTime(elapsed)}</div>
                        `;
                        item.onclick = () => selectCheckoutEmployee(profile.name);
                        list.appendChild(item);
                    }
                });
                
                showModal('checkout-selection-modal');
            } catch (error) {
                showStatus('Error opening checkout', 'error');
            }
        }

        function selectCheckoutEmployee(name) {
            try {
                hideModal('checkout-selection-modal');
                selectedCheckoutEmployee = name;
                document.getElementById('checkout-name').textContent = name;
                document.getElementById('checkout-reason').value = '';
                showModal('checkout-confirm-modal');
            } catch (error) {
                showStatus('Error selecting employee', 'error');
            }
        }

        function confirmCheckout() {
            try {
                const name = selectedCheckoutEmployee;
                if (!name) return;
                
                const profile = appData.profiles.find(p => p.name === name);
                if (!profile || !profile.activeSessionId) return;
                
                const session = appData.sessions.find(s => s.sessionId === profile.activeSessionId);
                if (!session) return;
                
                const reason = document.getElementById('checkout-reason').value.trim();
                
                session.checkOutTime = Date.now();
                session.reason = reason || null;
                profile.activeSessionId = null;
                
                if (saveData()) {
                    hideModal('checkout-confirm-modal');
                    showStatus(`${name} checked out successfully`);
                    selectedCheckoutEmployee = null;
                    updateUI();
                }
            } catch (error) {
                showStatus('Check-out failed', 'error');
            }
        }

        // ===== VIEW SWITCHING =====
        function switchView(view) {
            try {
                currentView = view;
                document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`${view}-btn`).classList.add('active');
                updateContent();
            } catch (error) {
                showStatus('Error switching view', 'error');
            }
        }

        function updateContent() {
            try {
                const container = document.getElementById('content-area');
                if (currentView === 'daily') {
                    renderDailyLog(container);
                } else if (currentView === 'monthly') {
                    renderMonthlyReport(container);
                } else if (currentView === 'history') {
                    renderHistory(container);
                } else if (currentView === 'analytics') {
                    renderAnalytics(container);
                } else if (currentView === 'compare') {
                    renderCompare(container);
                } else if (currentView === 'manage') {
                    renderManageEmployees(container);
                }
            } catch (error) {
                document.getElementById('content-area').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading content</p></div>';
            }
        }

        // ===== DAILY LOG =====
        function renderDailyLog(container) {
            try {
                const today = getTodayString();
                const sessions = appData.sessions.filter(s => getDateString(s.checkInTime) === today);
                
                if (sessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <p>No sessions recorded today</p>
                            <small>Check in employees to start tracking attendance</small>
                        </div>
                    `;
                    return;
                }
                
                let html = '<h3 class="content-title">Today\'s Sessions</h3>';
                html += '<div class="table-container"><table>';
                html += '<thead><tr><th>Employee</th><th>Check In</th><th>Check Out</th><th>Duration</th><th>Status</th></tr></thead><tbody>';
                
                sessions.sort((a, b) => b.checkInTime - a.checkInTime).forEach(s => {
                    const checkin = new Date(s.checkInTime);
                    const checkout = s.checkOutTime ? new Date(s.checkOutTime) : null;
                    const duration = checkout 
                        ? Math.floor((checkout - checkin) / 1000)
                        : Math.floor((Date.now() - checkin) / 1000);
                    
                    const isUnlocked = isEmployeeUnlocked(s.name);
                    
                    html += '<tr>';
                    html += `<td><strong>${isUnlocked ? s.name : maskEmployeeName(s.name)}</strong></td>`;
                    html += `<td>${isUnlocked ? checkin.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : maskEmployeeData('time')}</td>`;
                    html += `<td>${isUnlocked ? (checkout ? checkout.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : '‚Äî') : maskEmployeeData('time')}</td>`;
                    html += `<td><strong>${isUnlocked ? formatHoursMinutes(duration) : maskEmployeeData('duration')}</strong></td>`;
                    html += `<td><span class="status-badge-table status-${checkout ? 'completed' : 'active'}">${checkout ? 'Completed' : 'Active'}</span></td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading daily log</p></div>';
            }
        }

        // ===== MONTHLY REPORT =====
        function renderMonthlyReport(container) {
            try {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                
                const sessions = appData.sessions.filter(s => {
                    const d = new Date(s.checkInTime);
                    return d.getFullYear() === year && d.getMonth() === month;
                });
                
                if (sessions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <p>No data for this month</p>
                            <small>Sessions will appear here once recorded</small>
                        </div>
                    `;
                    return;
                }
                
                const stats = {};
                sessions.forEach(s => {
                    if (!stats[s.name]) {
                        stats[s.name] = { totalSeconds: 0, sessionCount: 0, days: new Set() };
                    }
                    const end = s.checkOutTime || Date.now();
                    stats[s.name].totalSeconds += Math.floor((end - s.checkInTime) / 1000);
                    stats[s.name].sessionCount++;
                    stats[s.name].days.add(getDateString(s.checkInTime));
                });
                
                let totalSeconds = 0;
                Object.values(stats).forEach(s => totalSeconds += s.totalSeconds);
                
                const monthName = now.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                
                let html = `<h3 class="content-title">${monthName} Report</h3>`;
                html += '<div class="summary-grid">';
                html += `
                    <div class="summary-card">
                        <h4>Total Hours</h4>
                        <div class="value">${formatHoursMinutes(totalSeconds)}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Total Sessions</h4>
                        <div class="value">${sessions.length}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Active Employees</h4>
                        <div class="value">${Object.keys(stats).length}</div>
                    </div>
                `;
                html += '</div>';
                
                html += '<div class="table-container"><table>';
                html += '<thead><tr><th>Employee</th><th>Sessions</th><th>Days Worked</th><th>Total Hours</th><th>Avg/Day</th></tr></thead><tbody>';
                
                Object.entries(stats).sort((a, b) => b[1].totalSeconds - a[1].totalSeconds).forEach(([name, s]) => {
                    const avgPerDay = s.days.size > 0 ? s.totalSeconds / s.days.size : 0;
                    const isUnlocked = isEmployeeUnlocked(name);
                    
                    html += '<tr>';
                    html += `<td><strong>${isUnlocked ? name : maskEmployeeName(name)}</strong></td>`;
                    html += `<td>${isUnlocked ? s.sessionCount : maskEmployeeData(s.sessionCount)}</td>`;
                    html += `<td>${isUnlocked ? s.days.size : maskEmployeeData(s.days.size)}</td>`;
                    html += `<td><strong>${isUnlocked ? formatHoursMinutes(s.totalSeconds) : maskEmployeeData('hours')}</strong></td>`;
                    html += `<td>${isUnlocked ? formatHoursMinutes(avgPerDay) : maskEmployeeData('hours')}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading report</p></div>';
            }
        }

        // ===== DATA MASKING FUNCTIONS =====
        function maskEmployeeName(name) {
            if (isEmployeeUnlocked(name)) {
                return name;
            }
            return '***';
        }

        function maskEmployeeData(data) {
            if (typeof data === 'string') {
                return '***';
            }
            if (typeof data === 'number') {
                return '***';
            }
            return data;
        }

        function isEmployeeUnlocked(name) {
            return employeePins[name] && employeePins[name].unlocked === true;
        }

        // ===== PIN MANAGEMENT =====
        function showPinModal(employeeName) {
            try {
                currentUnlockingEmployee = employeeName;
                const hasPin = employeePins[employeeName] && employeePins[employeeName].pin;
                
                if (hasPin) {
                    document.getElementById('pin-modal-title').textContent = 'Unlock Data';
                    document.getElementById('pin-modal-message').textContent = `Enter your 6-digit PIN to unlock ${employeeName}'s data`;
                    document.getElementById('pin-btn-text').textContent = 'Unlock';
                } else {
                    document.getElementById('pin-modal-title').textContent = 'Set PIN';
                    document.getElementById('pin-modal-message').textContent = `Create a 6-digit PIN for ${employeeName}`;
                    document.getElementById('pin-btn-text').textContent = 'Set PIN';
                }
                
                // Clear inputs
                document.querySelectorAll('.pin-input').forEach(input => {
                    input.value = '';
                    input.style.borderColor = 'var(--border)';
                });
                document.getElementById('pin-error').style.display = 'none';
                
                showModal('pin-modal');
                document.getElementById('pin-1').focus();
            } catch (error) {
                showStatus('Error opening PIN modal', 'error');
            }
        }

        function handlePinSubmit() {
            try {
                const pin = Array.from({length: 6}, (_, i) => 
                    document.getElementById(`pin-${i + 1}`).value
                ).join('');
                
                if (pin.length !== 6 || !/^\d{6}$/.test(pin)) {
                    showPinError('PIN must be exactly 6 digits');
                    return;
                }
                
                const employeeName = currentUnlockingEmployee;
                const hasPin = employeePins[employeeName] && employeePins[employeeName].pin;
                
                if (hasPin) {
                    // Verify PIN
                    if (employeePins[employeeName].pin === pin) {
                        employeePins[employeeName].unlocked = true;
                        savePins();
                        hideModal('pin-modal');
                        showStatus(`${employeeName}'s data unlocked`, 'success');
                        updateUI();
                    } else {
                        showPinError('Incorrect PIN');
                        // Shake animation
                        document.querySelectorAll('.pin-input').forEach(input => {
                            input.style.borderColor = 'var(--danger)';
                        });
                    }
                } else {
                    // Set new PIN
                    employeePins[employeeName] = { pin: pin, unlocked: true };
                    savePins();
                    hideModal('pin-modal');
                    showStatus(`PIN set successfully for ${employeeName}`, 'success');
                    updateUI();
                }
                
                currentUnlockingEmployee = null;
            } catch (error) {
                showStatus('Error processing PIN', 'error');
            }
        }

        function showPinError(message) {
            const errorDiv = document.getElementById('pin-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function lockEmployee(employeeName) {
            if (employeePins[employeeName]) {
                employeePins[employeeName].unlocked = false;
                savePins();
                showStatus(`${employeeName}'s data locked`, 'success');
                updateUI();
            }
        }

        // ===== MANAGE EMPLOYEES (Updated with Privacy) =====
        function renderManageEmployees(container) {
            try {
                if (appData.profiles.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üë•</div>
                            <p>No employees found</p>
                            <small>Add employees to start managing them</small>
                        </div>
                    `;
                    return;
                }

                let html = '<h3 class="content-title">Manage Employees</h3>';
                html += '<div class="table-container"><table>';
                html += '<thead><tr><th>Employee Name</th><th>Total Sessions</th><th>Status</th><th>Privacy</th><th>Actions</th></tr></thead><tbody>';
                
                appData.profiles.forEach(profile => {
                    const sessionCount = appData.sessions.filter(s => s.name === profile.name).length;
                    const isActive = profile.activeSessionId !== null;
                    const isUnlocked = isEmployeeUnlocked(profile.name);
                    const hasPin = employeePins[profile.name] && employeePins[profile.name].pin;
                    
                    html += '<tr>';
                    html += `<td><strong>${profile.name}</strong></td>`;
                    html += `<td>${isUnlocked ? sessionCount : '***'}</td>`;
                    html += `<td><span class="status-badge-table status-${isActive ? 'active' : 'completed'}">${isActive ? 'Active' : 'Inactive'}</span></td>`;
                    html += '<td>';
                    if (isUnlocked) {
                        html += `<button class="btn btn-secondary" onclick="lockEmployee('${profile.name}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;"><span>üîí</span> Lock</button>`;
                    } else {
                        html += `<button class="btn btn-primary" onclick="showPinModal('${profile.name}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;"><span>üëÅÔ∏è</span> ${hasPin ? 'Unlock' : 'Set PIN'}</button>`;
                    }
                    html += '</td>';
                    html += `<td><button class="btn btn-danger" onclick="deleteEmployee('${profile.name}')" style="padding: 0.5rem 1rem; font-size: 0.875rem;"><span>üóëÔ∏è</span> Delete</button></td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading employees</p></div>';
            }
        }

        function deleteEmployee(name) {
            if (!confirm(`Are you sure you want to delete ${name}?\n\nThis will also delete all their attendance records.`)) {
                return;
            }
            
            try {
                // Remove profile
                appData.profiles = appData.profiles.filter(p => p.name !== name);
                
                // Remove all sessions
                appData.sessions = appData.sessions.filter(s => s.name !== name);
                
                if (saveData()) {
                    showStatus(`${name} deleted successfully`);
                    updateUI();
                }
            } catch (error) {
                showStatus('Failed to delete employee', 'error');
            }
        }

        // ===== MANUAL RECORD (REMOVED) =====
        // Manual record feature has been removed as requested

        // ===== EXIT & BACKUP =====
        function showExitModal() {
            try {
                const activeCount = appData.profiles.filter(p => p.activeSessionId).length;
                document.getElementById('active-employees-exit').textContent = activeCount;
                showModal('exit-modal');
            } catch (error) {
                showStatus('Error opening exit dialog', 'error');
            }
        }

        function confirmExit() {
            try {
                // Create backup
                createBackup();
                
                // Show success message
                hideModal('exit-modal');
                showStatus('Backup created successfully!');
                
                // Optional: Clear active sessions
                const activeCount = appData.profiles.filter(p => p.activeSessionId).length;
                if (activeCount > 0) {
                    if (confirm('Do you want to automatically check out all active employees?')) {
                        appData.profiles.forEach(p => {
                            if (p.activeSessionId) {
                                const session = appData.sessions.find(s => s.sessionId === p.activeSessionId);
                                if (session) {
                                    session.checkOutTime = Date.now();
                                    session.reason = 'Auto check-out on pharmacy close';
                                    p.activeSessionId = null;
                                }
                            }
                        });
                        saveData();
                        updateUI();
                    }
                }
            } catch (error) {
                showStatus('Failed to create backup', 'error');
            }
        }

        function createBackup() {
            try {
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-');
                const filename = `pharmacy_attendance_backup_${timestamp}.json`;
                
                // Create detailed backup data
                const backupData = {
                    exportDate: now.toISOString(),
                    exportTimestamp: Date.now(),
                    version: '2.0',
                    pharmacyName: 'Pharmacy Attendance System',
                    summary: {
                        totalProfiles: appData.profiles.length,
                        totalSessions: appData.sessions.length,
                        activeEmployees: appData.profiles.filter(p => p.activeSessionId).length
                    },
                    profiles: appData.profiles.map(p => ({
                        name: p.name,
                        activeSessionId: p.activeSessionId,
                        totalSessions: appData.sessions.filter(s => s.name === p.name).length,
                        totalHours: calculateTotalHours(p.name)
                    })),
                    sessions: appData.sessions.map(s => ({
                        sessionId: s.sessionId,
                        employeeName: s.name,
                        checkInTime: s.checkInTime,
                        checkInTimeReadable: new Date(s.checkInTime).toLocaleString('en-US'),
                        checkOutTime: s.checkOutTime,
                        checkOutTimeReadable: s.checkOutTime ? new Date(s.checkOutTime).toLocaleString('en-US') : null,
                        duration: s.checkOutTime ? formatHoursMinutes(Math.floor((s.checkOutTime - s.checkInTime) / 1000)) : 'Active',
                        reason: s.reason
                    })),
                    rawData: appData
                };
                
                // Create and download file
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                
                return true;
            } catch (error) {
                return false;
            }
        }

        function calculateTotalHours(name) {
            const sessions = appData.sessions.filter(s => s.name === name);
            let totalSeconds = 0;
            sessions.forEach(s => {
                const end = s.checkOutTime || Date.now();
                totalSeconds += Math.floor((end - s.checkInTime) / 1000);
            });
            return formatHoursMinutes(totalSeconds);
        }

        // ===== HISTORY VIEW =====
        function renderHistory(container) {
            try {
                let html = '<h3 class="content-title">History & Calendar View</h3>';
                
                // Filter controls
                html += '<div class="filter-controls">';
                html += '<div class="filter-group">';
                html += '<label>View Type</label>';
                html += '<select id="history-calendar-type" onchange="switchCalendarView()">';
                html += '<option value="days">Days View</option>';
                html += '<option value="months">Months View</option>';
                html += '</select>';
                html += '</div>';
                html += '<div class="filter-group">';
                html += '<label>Employee</label>';
                html += '<select id="history-employee-filter" onchange="renderCalendar()">';
                html += '<option value="">All Employees</option>';
                appData.profiles.forEach(p => {
                    html += `<option value="${p.name}">${isEmployeeUnlocked(p.name) ? p.name : '***'}</option>`;
                });
                html += '</select>';
                html += '</div>';
                html += '<div class="filter-group">';
                html += '<label>List View</label>';
                html += '<select id="history-view-type" onchange="updateHistoryView()">';
                html += '<option value="calendar">Calendar</option>';
                html += '<option value="list">List View</option>';
                html += '</select>';
                html += '</div>';
                html += '</div>';
                
                html += '<div id="history-content-area"></div>';
                container.innerHTML = html;
                
                renderCalendar();
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading history</p></div>';
            }
        }

        function updateHistoryView() {
            const viewType = document.getElementById('history-view-type').value;
            if (viewType === 'calendar') {
                renderCalendar();
            } else {
                renderListView();
            }
        }

        function switchCalendarView() {
            const viewType = document.getElementById('history-calendar-type').value;
            calendarViewType = viewType;
            renderCalendar();
        }

        function renderCalendar() {
            try {
                if (calendarViewType === 'months') {
                    renderMonthsCalendar();
                } else {
                    renderDaysCalendar();
                }
            } catch (error) {
                // Silent fail
            }
        }

        function renderMonthsCalendar() {
            try {
                const employeeFilter = document.getElementById('history-employee-filter')?.value || '';
                const container = document.getElementById('history-content-area');
                
                const year = currentCalendarDate.getFullYear();
                
                let html = '<div class="calendar-container">';
                html += '<div class="calendar-header">';
                html += '<div class="calendar-nav">';
                html += '<button onclick="changeYear(-1)">‚Äπ Prev Year</button>';
                html += `<div class="calendar-title">${year}</div>`;
                html += '<button onclick="changeYear(1)">Next Year ‚Ä∫</button>';
                html += '</div>';
                html += '<button onclick="currentCalendarDate = new Date(); renderCalendar()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">This Year</button>';
                html += '</div>';
                
                // Months grid
                html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 2rem;">';
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                for (let month = 0; month < 12; month++) {
                    const monthStart = new Date(year, month, 1);
                    const monthEnd = new Date(year, month + 1, 0);
                    
                    let sessions = appData.sessions.filter(s => {
                        const sessionDate = new Date(s.checkInTime);
                        return sessionDate >= monthStart && sessionDate <= monthEnd;
                    });
                    
                    if (employeeFilter) {
                        sessions = sessions.filter(s => s.name === employeeFilter);
                    }
                    
                    const isCurrentMonth = month === currentMonth && year === currentYear;
                    const hasData = sessions.length > 0;
                    
                    let classes = 'calendar-day';
                    if (isCurrentMonth) classes += ' today';
                    if (hasData) classes += ' has-data';
                    
                    html += `<div class="${classes}" onclick="showMonthDetail(${year}, ${month})" style="padding: 2rem; aspect-ratio: auto;">`;
                    html += `<div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem;">${monthNames[month]}</div>`;
                    if (hasData) {
                        const unlockedSessions = sessions.filter(s => isEmployeeUnlocked(s.name));
                        html += `<div style="font-size: 0.9375rem; color: var(--text-muted);">${unlockedSessions.length > 0 ? unlockedSessions.length : '***'} session${sessions.length > 1 ? 's' : ''}</div>`;
                    } else {
                        html += `<div style="font-size: 0.9375rem; color: var(--text-muted);">No sessions</div>`;
                    }
                    html += '</div>';
                }
                
                html += '</div></div>';
                container.innerHTML = html;
            } catch (error) {
                // Silent fail
            }
        }

        function changeYear(delta) {
            currentCalendarDate.setFullYear(currentCalendarDate.getFullYear() + delta);
            renderCalendar();
        }

        function showMonthDetail(year, month) {
            try {
                selectedDayData = { year, month };
                const monthName = new Date(year, month).toLocaleDateString('en-US', { 
                    month: 'long', 
                    year: 'numeric'  
                });
                
                document.getElementById('month-detail-title').textContent = monthName;
                
                // Populate employee filter
                const monthStart = new Date(year, month, 1);
                const monthEnd = new Date(year, month + 1, 0);
                const employeesInMonth = new Set(
                    appData.sessions
                        .filter(s => {
                            const d = new Date(s.checkInTime);
                            return d >= monthStart && d <= monthEnd;
                        })
                        .map(s => s.name)
                );
                
                const select = document.getElementById('month-detail-employee');
                select.innerHTML = '<option value="">All Employees</option>';
                employeesInMonth.forEach(name => {
                    select.innerHTML += `<option value="${name}">${isEmployeeUnlocked(name) ? name : '***'}</option>`;
                });
                
                updateMonthDetail();
                showModal('month-detail-modal');
            } catch (error) {
                showStatus('Error loading month details', 'error');
            }
        }

        function updateMonthDetail() {
            try {
                const { year, month } = selectedDayData;
                const employeeFilter = document.getElementById('month-detail-employee').value;
                
                const monthStart = new Date(year, month, 1);
                const monthEnd = new Date(year, month + 1, 0);
                
                let sessions = appData.sessions.filter(s => {
                    const sessionDate = new Date(s.checkInTime);
                    return sessionDate >= monthStart && sessionDate <= monthEnd;
                });
                
                if (employeeFilter) {
                    sessions = sessions.filter(s => s.name === employeeFilter);
                }
                
                const container = document.getElementById('month-detail-content');
                
                if (sessions.length === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 2rem;"><p>No sessions found</p></div>';
                    return;
                }
                
                // Calculate summary
                let totalSeconds = 0;
                const employeeStats = {};
                const daysWorked = new Set();
                
                sessions.forEach(s => {
                    if (isEmployeeUnlocked(s.name)) {
                        const end = s.checkOutTime || Date.now();
                        const duration = Math.floor((end - s.checkInTime) / 1000);
                        totalSeconds += duration;
                        daysWorked.add(getDateString(s.checkInTime));
                        
                        if (!employeeStats[s.name]) {
                            employeeStats[s.name] = { sessions: 0, seconds: 0 };
                        }
                        employeeStats[s.name].sessions++;
                        employeeStats[s.name].seconds += duration;
                    }
                });
                
                let html = '<div class="summary-grid" style="margin-bottom: 2rem;">';
                html += `
                    <div class="summary-card">
                        <h4>Total Hours</h4>
                        <div class="value">${totalSeconds > 0 ? formatHoursMinutes(totalSeconds) : '***'}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Total Sessions</h4>
                        <div class="value">${Object.keys(employeeStats).length > 0 ? sessions.filter(s => isEmployeeUnlocked(s.name)).length : '***'}</div>
                    </div>
                    <div class="summary-card">
                        <h4>Days Worked</h4>
                        <div class="value">${daysWorked.size > 0 ? daysWorked.size : '***'}</div>
                    </div>
                `;
                html += '</div>';
                
                html += '<div class="table-container"><table>';
                html += '<thead><tr><th>Employee</th><th>Date</th><th>Check In</th><th>Check Out</th><th>Duration</th></tr></thead><tbody>';
                
                sessions.sort((a, b) => b.checkInTime - a.checkInTime).forEach(s => {
                    const checkin = new Date(s.checkInTime);
                    const checkout = s.checkOutTime ? new Date(s.checkOutTime) : null;
                    const duration = checkout 
                        ? Math.floor((checkout - checkin) / 1000)
                        : Math.floor((Date.now() - checkin) / 1000);
                    
                    const isUnlocked = isEmployeeUnlocked(s.name);
                    
                    html += '<tr>';
                    html += `<td><strong>${isUnlocked ? s.name : maskEmployeeName(s.name)}</strong></td>`;
                    html += `<td>${isUnlocked ? checkin.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '***'}</td>`;
                    html += `<td>${isUnlocked ? checkin.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : '***'}</td>`;
                    html += `<td>${isUnlocked ? (checkout ? checkout.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : 'Active') : '***'}</td>`;
                    html += `<td><strong>${isUnlocked ? formatHoursMinutes(duration) : '***'}</strong></td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                // Silent fail
            }
        }

        function renderDaysCalendar() {
            try {
                const employeeFilter = document.getElementById('history-employee-filter')?.value || '';
                const container = document.getElementById('history-content-area');
                
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                const monthName = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                let html = '<div class="calendar-container">';
                html += '<div class="calendar-header">';
                html += '<div class="calendar-nav">';
                html += '<button onclick="changeMonth(-1)">‚Äπ Prev</button>';
                html += `<div class="calendar-title">${monthName}</div>`;
                html += '<button onclick="changeMonth(1)">Next ‚Ä∫</button>';
                html += '</div>';
                html += '<button onclick="currentCalendarDate = new Date(); renderCalendar()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Today</button>';
                html += '</div>';
                
                // Calendar grid
                html += '<div class="calendar-grid">';
                
                // Day headers
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                days.forEach(day => {
                    html += `<div class="calendar-day-header">${day}</div>`;
                });
                
                // Get first day of month and number of days
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();
                
                // Previous month days
                for (let i = firstDay - 1; i >= 0; i--) {
                    const day = daysInPrevMonth - i;
                    html += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
                }
                
                // Current month days
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = getDateString(date.getTime());
                    
                    let sessions = appData.sessions.filter(s => getDateString(s.checkInTime) === dateStr);
                    if (employeeFilter) {
                        sessions = sessions.filter(s => s.name === employeeFilter);
                    }
                    
                    const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                    const hasData = sessions.length > 0;
                    
                    let classes = 'calendar-day';
                    if (isToday) classes += ' today';
                    if (hasData) classes += ' has-data';
                    
                    html += `<div class="${classes}" onclick="showDayDetail('${dateStr}')">`;
                    html += `<div class="calendar-day-number">${day}</div>`;
                    if (hasData) {
                        html += `<div class="calendar-day-sessions">${sessions.length} session${sessions.length > 1 ? 's' : ''}</div>`;
                    }
                    html += '</div>';
                }
                
                html += '</div></div>';
                container.innerHTML = html;
            } catch (error) {
                // Silent fail
            }
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function showDayDetail(dateStr) {
            try {
                selectedDayData = dateStr;
                const date = new Date(dateStr);
                const dateFormatted = date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                document.getElementById('day-detail-title').textContent = dateFormatted;
                
                // Populate employee filter
                const select = document.getElementById('day-detail-employee');
                select.innerHTML = '<option value="">All Employees</option>';
                const employeesOnDay = new Set(
                    appData.sessions
                        .filter(s => getDateString(s.checkInTime) === dateStr)
                        .map(s => s.name)
                );
                employeesOnDay.forEach(name => {
                    select.innerHTML += `<option value="${name}">${name}</option>`;
                });
                
                updateDayDetail();
                showModal('day-detail-modal');
            } catch (error) {
                showStatus('Error loading day details', 'error');
            }
        }

        function updateDayDetail() {
            try {
                const employeeFilter = document.getElementById('day-detail-employee').value;
                let sessions = appData.sessions.filter(s => getDateString(s.checkInTime) === selectedDayData);
                
                if (employeeFilter) {
                    sessions = sessions.filter(s => s.name === employeeFilter);
                }
                
                const container = document.getElementById('day-detail-content');
                
                if (sessions.length === 0) {
                    container.innerHTML = '<div class="empty-state" style="padding: 2rem;"><p>No sessions found</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table>';
                html += '<thead><tr><th>Employee</th><th>Check In</th><th>Check Out</th><th>Duration</th></tr></thead><tbody>';
                
                sessions.forEach(s => {
                    const checkin = new Date(s.checkInTime);
                    const checkout = s.checkOutTime ? new Date(s.checkOutTime) : null;
                    const duration = checkout 
                        ? Math.floor((checkout - checkin) / 1000)
                        : Math.floor((Date.now() - checkin) / 1000);
                    
                    const isUnlocked = isEmployeeUnlocked(s.name);
                    
                    html += '<tr>';
                    html += `<td><strong>${isUnlocked ? s.name : maskEmployeeName(s.name)}</strong></td>`;
                    html += `<td>${isUnlocked ? checkin.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : maskEmployeeData('time')}</td>`;
                    html += `<td>${isUnlocked ? (checkout ? checkout.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : 'Active') : maskEmployeeData('time')}</td>`;
                    html += `<td><strong>${isUnlocked ? formatHoursMinutes(duration) : maskEmployeeData('duration')}</strong></td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                // Silent fail
            }
        }

        function renderListView() {
            try {
                const employeeFilter = document.getElementById('history-employee-filter').value;
                const container = document.getElementById('history-content-area');
                
                let sessions = [...appData.sessions];
                if (employeeFilter) {
                    sessions = sessions.filter(s => s.name === employeeFilter);
                }
                
                if (sessions.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìã</div><p>No sessions found</p></div>';
                    return;
                }
                
                // Group by date
                const grouped = {};
                sessions.forEach(s => {
                    const dateStr = getDateString(s.checkInTime);
                    if (!grouped[dateStr]) grouped[dateStr] = [];
                    grouped[dateStr].push(s);
                });
                
                let html = '';
                Object.keys(grouped).sort().reverse().forEach(dateStr => {
                    const date = new Date(dateStr);
                    const dateFormatted = date.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    
                    html += `<h4 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--text-primary); font-size: 1.25rem;">${dateFormatted}</h4>`;
                    html += '<div class="table-container"><table>';
                    html += '<thead><tr><th>Employee</th><th>Check In</th><th>Check Out</th><th>Duration</th></tr></thead><tbody>';
                    
                    grouped[dateStr].sort((a, b) => b.checkInTime - a.checkInTime).forEach(s => {
                        const checkin = new Date(s.checkInTime);
                        const checkout = s.checkOutTime ? new Date(s.checkOutTime) : null;
                        const duration = checkout 
                            ? Math.floor((checkout - checkin) / 1000)
                            : Math.floor((Date.now() - checkin) / 1000);
                        
                        const isUnlocked = isEmployeeUnlocked(s.name);
                        
                        html += '<tr>';
                        html += `<td><strong>${isUnlocked ? s.name : maskEmployeeName(s.name)}</strong></td>`;
                        html += `<td>${isUnlocked ? checkin.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : maskEmployeeData('time')}</td>`;
                        html += `<td>${isUnlocked ? (checkout ? checkout.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : 'Active') : maskEmployeeData('time')}</td>`;
                        html += `<td><strong>${isUnlocked ? formatHoursMinutes(duration) : maskEmployeeData('duration')}</strong></td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                });
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading list view</p></div>';
            }
        }

        // ===== ANALYTICS VIEW =====
        function renderAnalytics(container) {
            try {
                let html = '<h3 class="content-title">Analytics & Charts</h3>';
                
                // Employee selector
                html += '<div class="filter-controls">';
                html += '<div class="filter-group">';
                html += '<label>Select Employee</label>';
                html += '<select id="analytics-employee" onchange="updateAnalytics()">';
                html += '<option value="">Select an employee...</option>';
                appData.profiles.forEach(p => {
                    html += `<option value="${p.name}">${isEmployeeUnlocked(p.name) ? p.name : '***'}</option>`;
                });
                html += '</select>';
                html += '</div>';
                html += '<div class="filter-group">';
                html += '<label>Time Period</label>';
                html += '<select id="analytics-period" onchange="updateAnalytics()">';
                html += '<option value="week">Last 7 Days</option>';
                html += '<option value="month" selected>Last 30 Days</option>';
                html += '<option value="year">Last 12 Months</option>';
                html += '</select>';
                html += '</div>';
                html += '<div class="filter-group">';
                html += '<label>Chart Type</label>';
                html += '<select id="analytics-chart-type" onchange="updateAnalytics()">';
                html += '<option value="line">Line Chart</option>';
                html += '<option value="bar">Bar Chart</option>';
                html += '<option value="pie">Pie Chart</option>';
                html += '</select>';
                html += '</div>';
                html += '</div>';
                
                html += '<div id="analytics-content"></div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading analytics</p></div>';
            }
        }

        function updateAnalytics() {
            const employee = document.getElementById('analytics-employee').value;
            const period = document.getElementById('analytics-period').value;
            const chartType = document.getElementById('analytics-chart-type').value;
            const container = document.getElementById('analytics-content');
            
            if (!employee) {
                container.innerHTML = '<div class="empty-state" style="padding: 3rem;"><div class="empty-icon">üìä</div><p>Select an employee to view analytics</p></div>';
                return;
            }
            
            if (!isEmployeeUnlocked(employee)) {
                container.innerHTML = '<div class="empty-state" style="padding: 3rem;"><div class="empty-icon">üîí</div><p>This employee\'s data is locked. Enter PIN to view.</p></div>';
                return;
            }
            
            const sessions = appData.sessions.filter(s => s.name === employee);
            
            if (sessions.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 3rem;"><div class="empty-icon">üìã</div><p>No data available for this employee</p></div>';
                return;
            }
            
            // Calculate statistics
            const now = Date.now();
            let periodMs = 30 * 24 * 60 * 60 * 1000; // 30 days
            if (period === 'week') periodMs = 7 * 24 * 60 * 60 * 1000;
            if (period === 'year') periodMs = 365 * 24 * 60 * 60 * 1000;
            
            const periodSessions = sessions.filter(s => s.checkInTime > now - periodMs);
            
            let totalSeconds = 0;
            let totalSessions = periodSessions.length;
            const daysWorked = new Set();
            
            periodSessions.forEach(s => {
                const end = s.checkOutTime || now;
                totalSeconds += Math.floor((end - s.checkInTime) / 1000);
                daysWorked.add(getDateString(s.checkInTime));
            });
            
            const avgPerDay = daysWorked.size > 0 ? totalSeconds / daysWorked.size : 0;
            const avgPerSession = totalSessions > 0 ? totalSeconds / totalSessions : 0;
            
            // Render summary and charts
            let html = '<div class="summary-grid">';
            html += `
                <div class="summary-card">
                    <h4>Total Hours</h4>
                    <div class="value">${formatHoursMinutes(totalSeconds)}</div>
                </div>
                <div class="summary-card">
                    <h4>Days Worked</h4>
                    <div class="value">${daysWorked.size}</div>
                </div>
                <div class="summary-card">
                    <h4>Total Sessions</h4>
                    <div class="value">${totalSessions}</div>
                </div>
                <div class="summary-card">
                    <h4>Avg Hours/Day</h4>
                    <div class="value">${formatHoursMinutes(avgPerDay)}</div>
                </div>
                <div class="summary-card">
                    <h4>Avg Hours/Session</h4>
                    <div class="value">${formatHoursMinutes(avgPerSession)}</div>
                </div>
            `;
            html += '</div>';
            
            // Chart container
            html += '<div class="chart-container">';
            html += `<h4 style="margin-bottom: 1.5rem; color: var(--text-primary);">${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Chart - Daily Hours</h4>`;
            html += '<canvas id="analytics-chart" style="max-height: 400px;"></canvas>';
            html += '</div>';
            
            container.innerHTML = html;
            
            // Render chart
            setTimeout(() => renderChart(periodSessions, chartType, period), 100);
        }

        function renderChart(sessions, chartType, period) {
            const canvas = document.getElementById('analytics-chart');
            if (!canvas) return;
            
            // Destroy previous chart
            if (currentChartInstance) {
                currentChartInstance.destroy();
                currentChartInstance = null;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Prepare data
            const dailyHours = {};
            sessions.forEach(s => {
                const dateStr = getDateString(s.checkInTime);
                const end = s.checkOutTime || Date.now();
                const hours = (end - s.checkInTime) / (1000 * 60 * 60);
                dailyHours[dateStr] = (dailyHours[dateStr] || 0) + hours;
            });
            
            const sortedDates = Object.keys(dailyHours).sort();
            const labels = sortedDates.map(d => {
                const date = new Date(d);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const data = sortedDates.map(d => dailyHours[d].toFixed(2));
            
            if (chartType === 'pie') {
                // Pie chart: Show distribution of hours across days
                const colors = generateColors(labels.length);
                
                currentChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#1e293b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: '#f1f5f9',
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + ' hours';
                                    }
                                }
                            }
                        }
                    }
                });
            } else if (chartType === 'bar') {
                currentChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Hours Worked',
                            data: data,
                            backgroundColor: 'rgba(99, 102, 241, 0.8)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#cbd5e1' },
                                grid: { color: '#334155' }
                            },
                            x: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: '#334155' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#f1f5f9' }
                            }
                        }
                    }
                });
            } else {
                // Line chart
                currentChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Hours Worked',
                            data: data,
                            fill: true,
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(139, 92, 246, 1)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#cbd5e1' },
                                grid: { color: '#334155' }
                            },
                            x: {
                                ticks: { color: '#cbd5e1' },
                                grid: { color: '#334155' }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#f1f5f9' }
                            }
                        }
                    }
                });
            }
        }

        function generateColors(count) {
            const colors = [
                'rgba(99, 102, 241, 0.8)',
                'rgba(139, 92, 246, 0.8)',
                'rgba(59, 130, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(239, 68, 68, 0.8)',
                'rgba(236, 72, 153, 0.8)',
                'rgba(14, 165, 233, 0.8)'
            ];
            
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        function renderSimpleBarChart(sessions, period) {
            // This function is no longer needed - replaced by Chart.js
            return '';
        }

        // ===== COMPARE VIEW =====
        function renderCompare(container) {
            try {
                let html = '<h3 class="content-title">Compare Employees</h3>';
                
                html += '<div class="filter-controls">';
                html += '<div class="filter-group">';
                html += '<label>Time Period</label>';
                html += '<select id="compare-period" onchange="updateCompare()">';
                html += '<option value="week">Last 7 Days</option>';
                html += '<option value="month" selected>Last 30 Days</option>';
                html += '<option value="year">Last 12 Months</option>';
                html += '<option value="all">All Time</option>';
                html += '</select>';
                html += '</div>';
                html += '</div>';
                
                html += '<div id="compare-content"></div>';
                container.innerHTML = html;
                
                updateCompare();
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>Error loading comparison</p></div>';
            }
        }

        function updateCompare() {
            const period = document.getElementById('compare-period').value;
            const container = document.getElementById('compare-content');
            
            if (appData.profiles.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 3rem;"><div class="empty-icon">üë•</div><p>No employees to compare</p></div>';
                return;
            }
            
            const now = Date.now();
            let periodMs = 30 * 24 * 60 * 60 * 1000;
            if (period === 'week') periodMs = 7 * 24 * 60 * 60 * 1000;
            if (period === 'year') periodMs = 365 * 24 * 60 * 60 * 1000;
            if (period === 'all') periodMs = Infinity;
            
            const employeeStats = appData.profiles.map(profile => {
                const sessions = appData.sessions.filter(s => 
                    s.name === profile.name && s.checkInTime > now - periodMs
                );
                
                let totalSeconds = 0;
                const daysWorked = new Set();
                
                sessions.forEach(s => {
                    const end = s.checkOutTime || now;
                    totalSeconds += Math.floor((end - s.checkInTime) / 1000);
                    daysWorked.add(getDateString(s.checkInTime));
                });
                
                return {
                    name: profile.name,
                    totalHours: totalSeconds / 3600,
                    totalSeconds,
                    sessions: sessions.length,
                    daysWorked: daysWorked.size,
                    avgPerDay: daysWorked.size > 0 ? totalSeconds / daysWorked.size : 0
                };
            });
            
            employeeStats.sort((a, b) => b.totalSeconds - a.totalSeconds);
            
            let html = '<div class="compare-grid">';
            
            employeeStats.forEach((stats, index) => {
                const isWinner = index === 0 && stats.totalSeconds > 0;
                const isUnlocked = isEmployeeUnlocked(stats.name);
                
                html += `<div class="compare-card ${isWinner ? 'winner' : ''}">`;
                html += '<div class="compare-card-header">';
                html += `<div class="compare-card-name">${isUnlocked ? stats.name : maskEmployeeName(stats.name)}</div>`;
                if (isWinner && isUnlocked) {
                    html += '<div class="compare-badge">üèÜ Top Performer</div>';
                }
                html += '</div>';
                html += '<div class="compare-stats">';
                html += `
                    <div class="compare-stat">
                        <span class="compare-stat-label">Total Hours</span>
                        <span class="compare-stat-value">${isUnlocked ? formatHoursMinutes(stats.totalSeconds) : maskEmployeeData('hours')}</span>
                    </div>
                    <div class="compare-stat">
                        <span class="compare-stat-label">Sessions</span>
                        <span class="compare-stat-value">${isUnlocked ? stats.sessions : maskEmployeeData(stats.sessions)}</span>
                    </div>
                    <div class="compare-stat">
                        <span class="compare-stat-label">Days Worked</span>
                        <span class="compare-stat-value">${isUnlocked ? stats.daysWorked : maskEmployeeData(stats.daysWorked)}</span>
                    </div>
                    <div class="compare-stat">
                        <span class="compare-stat-label">Avg/Day</span>
                        <span class="compare-stat-value">${isUnlocked ? formatHoursMinutes(stats.avgPerDay) : maskEmployeeData('hours')}</span>
                    </div>
                `;
                html += '</div>';
                html += '</div>';
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ===== START APP =====
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
